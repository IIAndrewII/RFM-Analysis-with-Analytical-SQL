# RFM-Analysis-with-Analytical-SQL

Customers has purchasing transaction that we shall be monitoring to get intuition behind each customer behavior to target the customers in the most efficient and proactive way, to increase sales/revenue , improve customer retention and decrease churn using RFM analysis.

## What is RFM (recency, frequency, monetary) analysis? 
RFM analysis is a marketing technique used to quantitatively rank and group customers based on the recency, frequency and monetary total of their recent transactions to identify the best customers and perform targeted marketing campaigns.


## We will use an OnlineRetail dataset.
### 1- let's first get more familiar with the data:

```sql
select * from tableretail;         
```
Sample from the output:

| STOCKCODE | QUANTITY| PRICE | INVOICEDATE | INVOICE | CUSTOMER_ID | COUNTRY |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: |
|537215 | 85124C | 12 | 12/5/2010 15:38 | 2.55 | 12747 | United Kingdom  | 
 |  537215 | 85124B | 6 | 12/5/2010 15:38 | 2.55 | 12747 | United Kingdom  | 
 |  537215 | 84879 | 16 | 12/5/2010 15:38 | 1.69 | 12747 | United Kingdom  | 
 |  537215 | 85062 | 24 | 12/5/2010 15:38 | 1.65 | 12747 | United Kingdom  | 
 |  .... | .... | .... | .... | .... | .... | ....  | 
 |  538537 | 22795 | 16 | 12/13/2010 10:41 | 5.95 | 12747 | United Kingdom  | 
 |  538537 | 48138 | 2 | 12/13/2010 10:41 | 7.95 | 12747 | United Kingdom  | 
 |  538537 | 82494L | 24 | 12/13/2010 10:41 | 2.55 | 12747 | United Kingdom  | 
 |  538537 | 84879 | 24 | 12/13/2010 10:41 | 1.69 | 12747 | United Kingdom |


```sql
select distinct(Invoice) , sum(QUANTITY)over(partition by Invoice) QUAN_per_Invoice
        from tableretail
        order by QUAN_per_Invoice;    
```
Sample from the output:
 | Invoice | QUAN_per_Invoice |
 | :---: | :---: |
 |  536521 | 1  | 
 |  536641 | 1  | 
 |  538669 | 1  | 
 |  539987 | 1  | 
 |  540251 | 1  | 
 |  551419 | 1  | 
 |  551424 | 1  | 
 |  551530 | 1  | 
 |  556456 | 1  | 
 |  .... | ....  | 
 |  538420 | 1728  | 
 |  567309 | 1788  | 
 |  568703 | 1816  | 
 |  561671 | 2064  | 
 |  566207 | 2352  | 
 |  557571 | 2668  | 
 |  575335 | 3684  | 
 |  554272 | 3863  | 
 |  573008 | 4936  | 
 |  563074 | 6098  | 
 |  562439 | 11848 |

We will use this output in the next query

```sql
select AVG(QUAN_per_Invoice) ,min( QUAN_per_Invoice) , max(QUAN_per_Invoice)
        From(
               select distinct(Invoice) , sum(QUANTITY)over(partition by Invoice) QUAN_per_Invoice
               from tableretail);
```

The output of the select statment:

| AVG(QUAN_per_Invoice) |MIN(QUAN_per_Invoice) | MAX(QUAN_per_Invoice) |
 | :---: | :---: | :---: |
| 246.377963737796 |	1 |	11848 |

The avrage quantity per Invoice is approximately 250, near to the min. value(1) and very far from the max. value(11848)

So, The data is right-skewed

```sql
select AVG(Price_per_Invoice) ,min( Price_per_Invoice) , max(Price_per_Invoice)
        From(
                    select distinct(Invoice) , sum(QUANTITY*Price)over(partition by Invoice) Price_per_Invoice
                    from tableretail);
```
The output of the select statment:

| AVG(Price_per_Invoice) |MIN(Price_per_Invoice) | MAX(Price_per_Invoice) |
 | :---: | :---: | :---: |
|356.650460251046 |	0	| 18841.48|

The avrage PRICE  per Invoice is approximately  360, near to the min. value(0) and very far from the max. value(18841.48)

So, The data is right-skewed (same as the avrage quantity)


```sql
select distinct(CUSTOMER_ID),               
            AVG(PRICE*QUANTITY) over(partition by CUSTOMER_ID) AVG_Total_PRICE,
            MIN(PRICE*QUANTITY) over(partition by CUSTOMER_ID) MIN_Total_PRICE,
            MAX(PRICE*QUANTITY) over(partition by CUSTOMER_ID) MAX_Total_PRICE    
from tableretail
order by AVG_Total_PRICE desc ;
```
The output of the select statment:

| CUSTOMER_ID | AVG_Total_PRICE | MIN_Total_PRICE | MAX_Total_PRICE |
 | :---: | :---: | :---: | :---: |
 | 12931 | 512.87756097561 | 6.36 | 4176  | 
 |  12908 | 375 | 318 | 432  | 
 |  12823 | 351.9 | 229.5 | 535.5  | 
 |  12917 | 297 | 297 | 297  | 
 |  12939 | 246.421276595745 | 69.12 | 650.88  | 
 |  12830 | 179.332631578947 | 51.84 | 587.52  | 
 |  12875 | 171.615 | 49.47 | 293.76  | 
 |  12901 | 152.194310344828 | 0.85 | 1519.8  | 
 |  12882 | 112.541538461538 | 56.4 | 283.2  | 
 |  12891 | 110.333333333333 | 42 | 204  | 
 |  12863 | 104.24 | 15 | 340  | 
 |  12873 | 93.5 | 68 | 102  | 
 |  12967 | 87.4157894736842 | 7.8 | 204  | 
 |  12950 | 80.1304347826087 | 9 | 179  | 
 |  12888 | 70.824 | 25.2 | 106.5  | 
 |  12912 | 69.2625 | 20.4 | 157.92  | 
 |  12879 | 57.322 | 8.5 | 183.6  | 
 |  12897 | 54.125 | 29.7 | 70.8  | 
 |  12913 | 49.6726 | 9.36 | 204  | 
 |  12864 | 49.04 | 10.2 | 119.52  | 
 |  12906 | 46.3461904761905 | 9.36 | 360  | 
 |  12884 | 44.15 | 17.85 | 170  | 
 |  12881 | 42.5714285714286 | 12.7 | 195  | 
 |  12910 | 41.0005333333333 | 8.4 | 102  | 
 |  12747 | 40.7379611650485 | 10.2 | 243  | 
 |  12871 | 34.6036363636364 | 5.04 | 163.2  | 
 |  12971 | 33.9264052287582 | 5.04 | 150  | 
 |  12842 | 32.9114705882353 | 6.64 | 122.4  | 
 |  12924 | 31.1233333333333 | 0.83 | 152.64  | 
 |  12916 | 28.0948598130841 | 1.65 | 163.2  | 
 |  12968 | 27.19 | 9.95 | 61.2  | 
 |  12919 | 26.7038 | 10.4 | 107.28  | 
 |  12829 | 26.6363636363636 | 11.4 | 79.9  | 
 |  12955 | 26.4286666666667 | 2.88 | 157.92  | 
 |  12853 | 25.0910256410256 | 10.2 | 81.6  | 
 |  12928 | 24.5559523809524 | 10.08 | 126  | 
 |  12840 | 24.1307079646018 | 9.96 | 59  | 
 |  12857 | 24.0521739130435 | 10.5 | 68  | 
 |  12909 | 23.9414285714286 | 2.88 | 290  | 
 |  12831 | 23.8944444444444 | 15 | 42  | 
 |  12921 | 23.037625 | 6.8 | 178.2  | 
 |  12822 | 20.6278260869565 | 6.96 | 102  | 
 |  12849 | 20.6056862745098 | 0.85 | 100  | 
 |  12749 | 20.5571859296482 | 6.64 | 114.75  | 
 |  12944 | 20.1503333333333 | 10.2 | 39.8  | 
 |  12945 | 20.1282608695652 | 15 | 58  | 
 |  12963 | 19.5434736842105 | 9.36 | 53.1  | 
 |  12953 | 19.4029411764706 | 15 | 35.4  | 
 |  12949 | 19.3824186046512 | 5.04 | 63.6  | 
 |  12852 | 18.3264705882353 | 13.2 | 34.8  | 
 |  12878 | 18.1912765957447 | 8.5 | 30.6  | 
 |  12828 | 18.19125 | 1 | 45.9  | 
 |  12839 | 17.8070700636943 | 2.98 | 70.8  | 
 |  12948 | 17.8012931034483 | 5.04 | 46.8  | 
 |  12952 | 17.5669620253164 | 6.64 | 33.9  | 
 |  12833 | 17.3908333333333 | 9.95 | 27.04  | 
 |  12834 | 17.3544444444444 | 11.9 | 25.2  | 
 |  12827 | 17.206 | 5.04 | 44.55  | 
 |  12936 | 17.1596774193548 | 0.39 | 102  | 
 |  12895 | 16.9454545454545 | 12.75 | 25  | 
 |  12951 | 16.89 | 2.9 | 35.7  | 
 |  12957 | 16.8804201680672 | 2.88 | 76.5  | 
 |  12886 | 16.809756097561 | 3.75 | 35.4  | 
 |  12935 | 16.7496124031008 | 7.8 | 40.8  | 
 |  12883 | 16.7492857142857 | 9.95 | 29.7  | 
 |  12962 | 16.649375 | 7.44 | 35.4  | 
 |  12930 | 16.632 | 6.72 | 27.04  | 
 |  12885 | 16.5523943661972 | 6.64 | 46.8  | 
 |  12947 | 16.5359793814433 | 3.36 | 130  | 
 |  12915 | 16.5295454545454 | 9.95 | 25.5  | 
 |  12843 | 16.5267961165049 | 0.78 | 59.4  | 
 |  12826 | 16.2057142857143 | 4.56 | 35.4  | 
 |  12966 | 16.018 | 11.7 | 25.2  | 
 |  12820 | 15.9718644067797 | 6.96 | 37.8  | 
 |  12824 | 15.8848 | 5.04 | 47.7  | 
 |  12821 | 15.4533333333333 | 10.2 | 19.92  | 
 |  12925 | 15.4233333333333 | 5.04 | 34.68  | 
 |  12868 | 15.0192523364486 | 3.12 | 31.6  | 
 |  12836 | 14.9306285714286 | 0.85 | 84.15  | 
 |  12929 | 14.73125 | 10.2 | 17.85  | 
 |  12922 | 14.4778571428571 | 7.8 | 35.4  | 
 |  12832 | 14.1862962962963 | 2.9 | 19.8  | 
 |  12902 | 13.868 | 5.04 | 17.7  | 
 |  12845 | 13.1144444444444 | 0.55 | 208.8  | 
 |  12855 | 12.7 | 10.2 | 17.7  | 
 |  12938 | 12.6822222222222 | 6.96 | 19.8  | 
 |  12937 | 12.5355833333333 | 0.85 | 81.6  | 
 |  12854 | 12.0409090909091 | 1.26 | 135.2  | 
 |  12837 | 11.175 | 3.9 | 25.5  | 
 |  12877 | 9.97253246753247 | 0.58 | 79.2  | 
 |  12847 | 9.57736263736264 | 0.38 | 46.8  | 
 |  12841 | 9.57702380952381 | 0.42 | 107.28  | 
 |  12940 | 9.22767676767677 | 2.5 | 51  | 
 |  12942 | 9.11866666666667 | 0.39 | 25.5  | 
 |  12872 | 9.09045454545455 | 0.95 | 41.3  | 
 |  12867 | 7.50338289962825 | 0.39 | 74.7  | 
 |  12748 | 7.33675587467363 | 0 | 850.5  | 
 |  12965 | 7.08174311926606 | 0.78 | 31.8  | 
 |  12904 | 7.0775 | 0.85 | 51  | 
 |  12856 | 6.94245222929936 | 0.55 | 49.92  | 
 |  12844 | 6.26846153846154 | 0.42 | 17.85  | 
 |  12923 | 6.10241379310345 | 0.42 | 19.9  | 
 |  12920 | 5.86535714285714 | 0.75 | 16.95  | 
 |  12933 | 5.73141509433962 | 0.38 | 52.5  | 
 |  12956 | 5.68789473684211 | 2.5 | 16.95  | 
 |  12838 | 5.55390243902439 | 0.42 | 35.4  | 
 |  12893 | 5.53352941176471 | 0.79 | 37.44  | 
 |  12890 | 4.63987804878049 | 0.39 | 45  | 
 |  12970 | 2.99496688741722 | 0.39 | 25.5  | 
 |  12851 | 2.7036 | 0.12 | 16.95 |

Most of the revenue of the online store (90%) from customers with average price less than 100

```sql
select distinct(CUSTOMER_ID),               
            AVG(QUANTITY) over(partition by CUSTOMER_ID) AVG_QUANTITY,
            MIN(QUANTITY) over(partition by CUSTOMER_ID) MIN_QUANTITY,
            MAX(QUANTITY) over(partition by CUSTOMER_ID) MAX_QUANTITY    
from tableretail
order by AVG_QUANTITY desc ;
```
The output of the select statment:

| CUSTOMER_ID | AVG_QUANTITY | MIN_QUANTITY | MAX_QUANTITY |
 | :---: | :---: | :---: | :---: |
 | 12875 | 1009.5 | 291 | 1728  | 
 |  12908 | 600 | 600 | 600  | 
 |  12931 | 341.512195121951 | 6 | 2880  | 
 |  12891 | 316.666666666667 | 100 | 600  | 
 |  12830 | 259.157894736842 | 72 | 864  | 
 |  12901 | 198.922413793103 | 1 | 4800  | 
 |  12939 | 103.744680851064 | 24 | 300  | 
 |  12864 | 72 | 12 | 144  | 
 |  12917 | 60 | 60 | 60  | 
 |  12950 | 60 | 12 | 200  | 
 |  12823 | 46 | 30 | 70  | 
 |  12863 | 37.6 | 12 | 100  | 
 |  12879 | 37 | 6 | 96  | 
 |  12829 | 34.1818181818182 | 1 | 120  | 
 |  12873 | 32 | 8 | 40  | 
 |  12913 | 28.38 | 1 | 96  | 
 |  12912 | 27.9166666666667 | 12 | 48  | 
 |  12906 | 27.7619047619048 | 1 | 128  | 
 |  12897 | 27.5 | 6 | 40  | 
 |  12971 | 25.437908496732 | 1 | 600  | 
 |  12967 | 23.0526315789474 | 6 | 60  | 
 |  12910 | 22.56 | 2 | 64  | 
 |  12955 | 20.3555555555555 | 2 | 96  | 
 |  12882 | 18.9230769230769 | 8 | 40  | 
 |  12871 | 18.1818181818182 | 2 | 64  | 
 |  12928 | 17.5238095238095 | 4 | 288  | 
 |  12842 | 16.0882352941176 | 1 | 48  | 
 |  12924 | 16.0333333333333 | 1 | 144  | 
 |  12938 | 15.5555555555556 | 6 | 48  | 
 |  12888 | 15.2 | 6 | 24  | 
 |  12831 | 15 | 2 | 36  | 
 |  12968 | 14.6 | 1 | 24  | 
 |  12935 | 14.3643410852713 | 1 | 48  | 
 |  12909 | 14.0659340659341 | 1 | 96  | 
 |  12919 | 13.46 | 2 | 72  | 
 |  12840 | 13.3716814159292 | 2 | 24  | 
 |  12921 | 13.2305555555555 | 1 | 96  | 
 |  12922 | 13.2142857142857 | 3 | 36  | 
 |  12747 | 12.378640776699 | 1 | 48  | 
 |  12820 | 12.2372881355932 | 4 | 48  | 
 |  12849 | 12.2156862745098 | 1 | 64  | 
 |  12839 | 12.124203821656 | 1 | 48  | 
 |  12925 | 12.0222222222222 | 1 | 48  | 
 |  12947 | 12.0103092783505 | 1 | 48  | 
 |  12822 | 11.9565217391304 | 2 | 48  | 
 |  12821 | 11.6666666666667 | 2 | 24  | 
 |  12878 | 11.6382978723404 | 2 | 24  | 
 |  12826 | 11.6263736263736 | 1 | 48  | 
 |  12949 | 11.0744186046512 | 1 | 48  | 
 |  12957 | 10.7100840336134 | 1 | 48  | 
 |  12916 | 10.4579439252336 | 1 | 64  | 
 |  12853 | 10.2564102564102 | 2 | 96  | 
 |  12930 | 10.08 | 1 | 32  | 
 |  12855 | 10 | 6 | 12  | 
 |  12847 | 9.98901098901099 | 1 | 72  | 
 |  12944 | 9.63333333333333 | 2 | 24  | 
 |  12895 | 9.54545454545455 | 1 | 24  | 
 |  12886 | 9.39024390243902 | 1 | 48  | 
 |  12948 | 9.31034482758621 | 1 | 48  | 
 |  12824 | 9.28 | 2 | 16  | 
 |  12963 | 9.27368421052632 | 1 | 48  | 
 |  12885 | 9.22535211267606 | 1 | 25  | 
 |  12936 | 9.01612903225806 | 1 | 40  | 
 |  12828 | 8.82142857142857 | 1 | 24  | 
 |  12852 | 8.76470588235294 | 2 | 24  | 
 |  12868 | 8.67289719626168 | 1 | 24  | 
 |  12937 | 8.39166666666667 | 1 | 72  | 
 |  12952 | 8.26582278481013 | 1 | 48  | 
 |  12962 | 8.0625 | 2 | 12  | 
 |  12867 | 7.98884758364312 | 1 | 72  | 
 |  12951 | 7.98412698412698 | 1 | 25  | 
 |  12827 | 7.88 | 3 | 12  | 
 |  12877 | 7.64935064935065 | 1 | 48  | 
 |  12843 | 7.58252427184466 | 1 | 48  | 
 |  12845 | 7.55555555555556 | 1 | 144  | 
 |  12966 | 7.5 | 1 | 12  | 
 |  12857 | 7.45652173913043 | 2 | 12  | 
 |  12749 | 7.39195979899497 | 1 | 75  | 
 |  12832 | 7.22222222222222 | 2 | 12  | 
 |  12945 | 7.17391304347826 | 2 | 40  | 
 |  12902 | 6.6 | 1 | 12  | 
 |  12841 | 6.56428571428571 | 1 | 72  | 
 |  12833 | 6.5 | 1 | 24  | 
 |  12884 | 6.14285714285714 | 2 | 10  | 
 |  12834 | 6.11111111111111 | 2 | 16  | 
 |  12836 | 6.08 | 1 | 36  | 
 |  12854 | 5.7 | 1 | 80  | 
 |  12748 | 5.60226283724978 | 1 | 576  | 
 |  12953 | 4.94117647058824 | 1 | 12  | 
 |  12872 | 4.83333333333333 | 1 | 30  | 
 |  12933 | 4.70754716981132 | 1 | 100  | 
 |  12883 | 4.66666666666667 | 1 | 24  | 
 |  12929 | 4.625 | 1 | 12  | 
 |  12920 | 4.60714285714286 | 1 | 36  | 
 |  12915 | 4.22727272727273 | 1 | 16  | 
 |  12904 | 4.19444444444444 | 1 | 41  | 
 |  12940 | 4.15151515151515 | 1 | 48  | 
 |  12856 | 3.43630573248408 | 1 | 48  | 
 |  12890 | 3.15853658536585 | 1 | 36  | 
 |  12881 | 3 | 1 | 6  | 
 |  12838 | 2.91869918699187 | 1 | 12  | 
 |  12893 | 2.82352941176471 | 1 | 18  | 
 |  12942 | 2.70666666666667 | 1 | 15  | 
 |  12965 | 2.59633027522936 | 1 | 24  | 
 |  12844 | 2.40384615384615 | 1 | 8  | 
 |  12923 | 2.37931034482759 | 1 | 6  | 
 |  12851 | 2.18 | 1 | 12  | 
 |  12970 | 2.05298013245033 | 1 | 36  | 
 |  12837 | 2 | 1 | 4  | 
 |  12956 | 1.78947368421053 | 1 | 8 |

Most of the revenue of the online store from customers (90%) with average quantity less than 40

```sql
select  distinct(COUNTRY), count(*)over(partition by COUNTRY) count
from tableretail;
```
The output of the select statment:

| COUNTRY | COUNT | 
 | :---: | :---: | 
 | United Kingdom	| 12858 | 
 
All the revenue of the online store from United Kingdom only



```sql
select  distinct(TO_CHAR(trunc(to_date( INVOICEDATE, 'MM/DD/YYYY HH24:MI'), 'Month'),'YYYY-MM'))     INVOICE_DATE,
            AVG(QUANTITY) over(partition by trunc(to_date( INVOICEDATE, 'MM/DD/YYYY HH24:MI'), 'Month')) AVG_QUANTITY,
            AVG(PRICE*QUANTITY) over(partition by trunc(to_date( INVOICEDATE, 'MM/DD/YYYY HH24:MI'), 'Month')) AVG_PRICE
from tableretail
order by INVOICE_DATE ;
```
The output of the select statment:

| INVOICE_DATE | AVG_QUANTITY | AVG_PRICE |
 | :---: | :---: | :---: | 
 |  2010-12 | 8.12302284710018 | 11.7952196836555  | 
 |  2011-01 | 12.9544468546638 | 20.6969414316703  | 
 |  2011-02 | 12.4586330935252 | 23.9871223021583  | 
 |  2011-03 | 14.5708390646492 | 23.4360522696011  | 
 |  2011-04 | 15.6805845511482 | 22.9238204592902  | 
 |  2011-05 | 13.8189216683622 | 19.8333468972533  | 
 |  2011-06 | 14.6335570469799 | 18.1436375838926  | 
 |  2011-07 | 16.0269179004038 | 21.0828263795424  | 
 |  2011-08 | 40.6739495798319 | 64.4951932773109  | 
 |  2011-09 | 13.8369950389794 | 19.7404819277108  | 
 |  2011-10 | 17.6321036889332 | 19.6760418743769  | 
 |  2011-11 | 9.6809375 | 14.26043125  | 
 |  2011-12 | 9.33047735618115 | 13.6158261933905 |

We will use this output in the next 2 queries



```sql
select INVOICE_DATE, AVG_QUANTITY, rank()over(order by AVG_QUANTITY desc) QUANTITY_RANC
from(
                    select  distinct(TO_CHAR(trunc(to_date( INVOICEDATE, 'MM/DD/YYYY HH24:MI'), 'Month'),'YYYY-MM'))     INVOICE_DATE,
                                AVG(QUANTITY) over(partition by trunc(to_date( INVOICEDATE, 'MM/DD/YYYY HH24:MI'), 'Month')) AVG_QUANTITY
                    from tableretail
                    order by INVOICE_DATE );                   
```

The output of the select statment:

| INVOICE_DATE | AVG_QUANTITY | QUANTITY_RANC |
 | :---: | :---: | :---: | 
 | 2011-08 | 40.6739495798319 | 1  | 
 |  2011-10 | 17.6321036889332 | 2  | 
 |  2011-07 | 16.0269179004038 | 3  | 
 |  2011-04 | 15.6805845511482 | 4  | 
 |  2011-06 | 14.6335570469799 | 5  | 
 |  2011-03 | 14.5708390646492 | 6  | 
 |  2011-09 | 13.8369950389794 | 7  | 
 |  2011-05 | 13.8189216683622 | 8  | 
 |  2011-01 | 12.9544468546638 | 9  | 
 |  2011-02 | 12.4586330935252 | 10  | 
 |  2011-11 | 9.6809375 | 11  | 
 |  2011-12 | 9.33047735618115 | 12  | 
 |  2010-12 | 8.12302284710018 | 13 |


December has the lowest quantities in both 2010,2011 while 2011-08 has the highest quantities



```sql
select INVOICE_DATE, AVG_PRICE, rank()over(order by AVG_PRICE desc) PRICE_RANC
from(
                    select  distinct(TO_CHAR(trunc(to_date( INVOICEDATE, 'MM/DD/YYYY HH24:MI'), 'Month'),'YYYY-MM'))     INVOICE_DATE,
                                AVG(PRICE*QUANTITY) over(partition by trunc(to_date( INVOICEDATE, 'MM/DD/YYYY HH24:MI'), 'Month')) AVG_PRICE
                    from tableretail
                    order by INVOICE_DATE );
```

The output of the select statment:

| INVOICE_DATE | AVG_PRICE | PRICE_RANC |
 | :---: | :---: | :---: | 
 | 2011-08 | 64.4951932773109 | 1  | 
 |  2011-02 | 23.9871223021583 | 2  | 
 |  2011-03 | 23.4360522696011 | 3  | 
 |  2011-04 | 22.9238204592902 | 4  | 
 |  2011-07 | 21.0828263795424 | 5  | 
 |  2011-01 | 20.6969414316703 | 6  | 
 |  2011-05 | 19.8333468972533 | 7  | 
 |  2011-09 | 19.7404819277108 | 8  | 
 |  2011-10 | 19.6760418743769 | 9  | 
 |  2011-06 | 18.1436375838926 | 10  | 
 |  2011-11 | 14.26043125 | 11  | 
 |  2011-12 | 13.6158261933905 | 12  | 
 |  2010-12 | 11.7952196836555 | 13 |
 
December has the lowest Price in both 2010,2011 while 2011-08 has the highest Price (same as quantities)


### 2- RFM Analysis 

```sql
-- Step 1 (get Recency, freguency, monetary, avg(freguency, monetary))
select distinct(CUSTOMER_ID),
            max(to_date( INVOICEDATE, 'MM/DD/YYYY HH24:MI'))over() - max(to_date( INVOICEDATE, 'MM/DD/YYYY HH24:MI'))over(partition by CUSTOMER_ID) Recency,
            count(*)over( partition by CUSTOMER_ID ) freguency,
            sum(PRICE*QUANTITY)over( partition by CUSTOMER_ID ) monetary,
            (count(*)over( partition by CUSTOMER_ID ) + sum(PRICE*QUANTITY)over( partition by CUSTOMER_ID ))/2 avg_FM
from tableretail;
```
Sample from the output of the select statment:

 | CUSTOMER_ID | RECENCY | FREQUENCY | MONETARY | AVG_FM |
 | :---: | :---: | :---: | :---: | :---: |
 | 12747 | 1.90694444444444 | 103 | 4196.01 | 2149.505  | 
 |  12748 | 0 | 4596 | 33719.73 | 19157.865  | 
 |  12830 | 37.0180555555555 | 38 | 6814.64 | 3426.32  | 
 |  12834 | 282.104861111111 | 18 | 312.38 | 165.19  | 
 |  12841 | 4.04652777777778 | 420 | 4022.35 | 2221.175  | 
 |  12849 | 30.94375 | 51 | 1050.89 | 550.945  | 
 |  12857 | 210.083333333333 | 46 | 1106.4 | 576.2  | 
 |  12864 | 137.970138888889 | 3 | 147.12 | 75.06  | 
 |  12867 | 25.8680555555555 | 538 | 4036.82 | 2287.41  | 
 |  12872 | 326.061111111111 | 66 | 599.97 | 332.985  | 
 |  12879 | 43.9972222222222 | 10 | 573.22 | 291.61  | 
 |  12919 | 7.93958333333333 | 50 | 1335.19 | 692.595  | 
 |  12924 | 87.9340277777778 | 30 | 933.7 | 481.85  | 
 |  12939 | 63.9076388888889 | 47 | 11581.8 | 5814.4  | 
 |  12957 | 9.10208333333333 | 238 | 4017.54 | 2127.77  | 
 |  12968 | 111.858333333333 | 5 | 135.95 | 70.475  | 
 |  12822 | 70.0944444444444 | 46 | 948.88 | 497.44  | 
 |  12851 | 95.9854166666667 | 50 | 135.18 | 92.59  | 
 |  12855 | 372.113194444444 | 3 | 38.1 | 20.55  | 
 |  12877 | 3.07638888888889 | 154 | 1535.77 | 844.885  | 
 |  12878 | 235.967361111111 | 47 | 854.99 | 450.995  | 
 |  12884 | 87.9652777777778 | 7 | 309.05 | 158.025  | 
 |  12886 | 67.0909722222222 | 82 | 1378.4 | 730.2  | 
 |  12917 | 127.818055555556 | 2 | 594 | 298  | 
 |  12921 | 8.83194444444444 | 720 | 16587.09 | 8653.545  | 
 |  12925 | 4.04791666666667 | 45 | 694.05 | 369.525  | 
 |  12930 | 77.8763888888889 | 25 | 415.8 | 220.4  | 
 |  12931 | 20.9868055555555 | 82 | 42055.96 | 21068.98  | 
 |  12843 | 65.0076388888889 | 103 | 1702.26 | 902.63  | 
 |  12863 | 51.9201388888889 | 5 | 521.2 | 263.1  | 
 |  12871 | 83.8840277777778 | 11 | 380.64 | 195.82  | 
 |  12890 | 23.7875 | 82 | 380.47 | 231.235  | 
 |  12895 | 41.9368055555556 | 22 | 372.8 | 197.4  | 
 |  12901 | 8.09236111111111 | 116 | 17654.54 | 8885.27  | 
 |  12902 | 264.009722222222 | 10 | 138.68 | 74.34  | 
 |  12916 | 138.072916666667 | 107 | 3006.15 | 1556.575  | 
 |  12922 | 160.864583333333 | 28 | 405.38 | 216.69  | 
 |  12928 | 34.9138888888889 | 84 | 2062.7 | 1073.35  | 
 |  12929 | 311.008333333333 | 8 | 117.85 | 62.925  | 
 |  12935 | 1.78819444444444 | 129 | 2160.7 | 1144.85  | 
 |  12944 | 35.0527777777778 | 30 | 604.51 | 317.255  | 
 |  12950 | 1.96041666666667 | 23 | 1843 | 933  | 
 |  12970 | 6.90972222222222 | 151 | 452.24 | 301.62  | 
 |  12824 | 58.9798611111111 | 25 | 397.12 | 211.06  | 
 |  12827 | 5.00208333333333 | 25 | 430.15 | 227.575  | 
 |  12832 | 31.9513888888889 | 27 | 383.03 | 205.015  | 
 |  12833 | 144.940277777778 | 24 | 417.38 | 220.69  | 
 |  12836 | 58.8819444444444 | 175 | 2612.86 | 1393.93  | 
 |  12844 | 28.9506944444444 | 52 | 325.96 | 188.98  | 
 |  12854 | 78.0034722222222 | 110 | 1324.5 | 717.25  | 
 |  12856 | 7.06111111111111 | 314 | 2179.93 | 1246.965  | 
 |  12873 | 281.890277777778 | 4 | 374 | 189  | 
 |  12883 | 24.1166666666667 | 42 | 703.47 | 372.735  | 
 |  12897 | 204.004861111111 | 4 | 216.5 | 110.25  | 
 |  12923 | 63.8333333333333 | 29 | 176.97 | 102.985  | 
 |  12933 | 23.8208333333333 | 106 | 607.53 | 356.765  | 
 |  12936 | 16.7833333333333 | 62 | 1063.9 | 562.95  | 
 |  12942 | 130.903472222222 | 75 | 683.9 | 379.45  | 
 |  12971 | 167.905555555556 | 153 | 5190.74 | 2671.87  | 
 |  12749 | 3.1 | 199 | 4090.88 | 2144.94  | 
 |  12826 | 2.07986111111111 | 91 | 1474.72 | 782.86  | 
 |  12875 | 142.868055555556 | 2 | 343.23 | 172.615  | 
 |  12885 | 62.9444444444444 | 71 | 1175.22 | 623.11  | 
 |  12904 | 17.9069444444444 | 72 | 509.58 | 290.79  | 
 |  12906 | 11.1006944444444 | 63 | 2919.81 | 1491.405  | 
 |  12908 | 175.861805555556 | 2 | 750 | 376  | 
 |  12913 | 4.00625 | 50 | 2483.63 | 1266.815  | 
 |  12920 | 16.8854166666667 | 28 | 164.23 | 96.115  | 
 |  12948 | 15.7986111111111 | 116 | 2064.95 | 1090.475  | 
 |  12951 | 8.00416666666667 | 63 | 1064.07 | 563.535  | 
 |  12953 | 9.12222222222222 | 17 | 329.85 | 173.425  | 
 |  12963 | 7.97569444444444 | 95 | 1856.63 | 975.815  | 
 |  12965 | 88.8673611111111 | 109 | 771.91 | 440.455  | 
 |  12966 | 8.9875 | 10 | 160.18 | 85.09  | 
 |  12823 | 74.1979166666667 | 5 | 1759.5 | 882.25  | 
 |  12828 | 2.14930555555556 | 56 | 1018.71 | 537.355  | 
 |  12831 | 261.970833333333 | 9 | 215.05 | 112.025  | 
 |  12868 | 185.068055555556 | 107 | 1607.06 | 857.03  | 
 |  12888 | 213.845833333333 | 5 | 354.12 | 179.56  | 
 |  12891 | 184.992361111111 | 3 | 331 | 167  | 
 |  12956 | 305.841666666667 | 19 | 108.07 | 63.535  | 
 |  12967 | 357.715277777778 | 19 | 1660.9 | 839.95  | 
 |  12821 | 213.853472222222 | 6 | 92.72 | 49.36  | 
 |  12829 | 336.046527777778 | 11 | 293 | 152  | 
 |  12839 | 1.99097222222222 | 314 | 5591.42 | 2952.71  | 
 |  12840 | 143.11875 | 113 | 2726.77 | 1419.885  | 
 |  12842 | 69.8659722222222 | 34 | 1118.99 | 576.495  | 
 |  12845 | 266.948611111111 | 27 | 354.09 | 190.545  | 
 |  12853 | 134.035416666667 | 78 | 1957.1 | 1017.55  | 
 |  12881 | 275.025 | 7 | 298 | 152.5  | 
 |  12882 | 8.83472222222222 | 13 | 1463.04 | 738.02  | 
 |  12909 | 38.9840277777778 | 91 | 2178.67 | 1134.835  | 
 |  12910 | 22.9111111111111 | 75 | 3075.04 | 1575.02  | 
 |  12938 | 25.0409722222222 | 9 | 114.14 | 61.57  | 
 |  12940 | 54.0076388888889 | 99 | 913.54 | 506.27  | 
 |  12947 | 143.093055555556 | 97 | 1603.99 | 850.495  | 
 |  12955 | 0.827083333333333 | 180 | 4757.16 | 2468.58  | 
 |  12962 | 6.85069444444444 | 16 | 266.39 | 141.195  | 
 |  12820 | 2.88055555555556 | 59 | 942.34 | 500.67  | 
 |  12837 | 172.842361111111 | 12 | 134.1 | 73.05  | 
 |  12838 | 33 | 123 | 683.13 | 403.065  | 
 |  12847 | 21.9611111111111 | 91 | 871.54 | 481.27  | 
 |  12852 | 294.147916666667 | 17 | 311.55 | 164.275  | 
 |  12893 | 29.9902777777778 | 34 | 188.14 | 111.07  | 
 |  12912 | 2.14236111111111 | 24 | 1662.3 | 843.15  | 
 |  12915 | 148.031944444444 | 22 | 363.65 | 192.825  | 
 |  12937 | 14.8854166666667 | 120 | 1504.27 | 812.135  | 
 |  12945 | 287.920138888889 | 23 | 462.95 | 242.975  | 
 |  12949 | 30.0381944444444 | 215 | 4167.22 | 2191.11  | 
 |  12952 | 5.07291666666667 | 79 | 1387.79 | 733.395 |


```sql
-- Step 2  break the resultset into approximately equal groups 
select CUSTOMER_ID, Recency, freguency, monetary,
        NTILE(5) over(order by Recency)  R_Score,
        NTILE(5) over(order by avg_FM)  FM_Score
        from(      
                select distinct(CUSTOMER_ID),
                            max(to_date( INVOICEDATE, 'MM/DD/YYYY HH24:MI'))over() - max(to_date( INVOICEDATE, 'MM/DD/YYYY HH24:MI'))over(partition by CUSTOMER_ID) Recency,
                            count(*)over( partition by CUSTOMER_ID ) freguency,
                            sum(PRICE*QUANTITY)over( partition by CUSTOMER_ID ) monetary,
                            (count(*)over( partition by CUSTOMER_ID ) + sum(PRICE*QUANTITY)over( partition by CUSTOMER_ID ))/2 avg_FM
                from tableretail);

```

Sample from the output of the select statment:

 | CUSTOMER_ID | RECENCY | FREQUENCY | MONETARY | R_SCORE | FM_SCORE |
 | :---: | :---: | :---: | :---: | :---: | :---: |
 | 12855 | 372.113194444444 | 3 | 38.1 | 5 | 1  | 
 |  12821 | 213.853472222222 | 6 | 92.72 | 5 | 1  | 
 |  12938 | 25.0409722222222 | 9 | 114.14 | 2 | 1  | 
 |  12929 | 311.008333333333 | 8 | 117.85 | 5 | 1  | 
 |  12956 | 305.841666666667 | 19 | 108.07 | 5 | 1  | 
 |  12968 | 111.858333333333 | 5 | 135.95 | 4 | 1  | 
 |  12837 | 172.842361111111 | 12 | 134.1 | 4 | 1  | 
 |  12902 | 264.009722222222 | 10 | 138.68 | 5 | 1  | 
 |  12864 | 137.970138888889 | 3 | 147.12 | 4 | 1  | 
 |  12966 | 8.9875 | 10 | 160.18 | 2 | 1  | 
 |  12851 | 95.9854166666667 | 50 | 135.18 | 4 | 1  | 
 |  12920 | 16.8854166666667 | 28 | 164.23 | 2 | 1  | 
 |  12923 | 63.8333333333333 | 29 | 176.97 | 3 | 1  | 
 |  12897 | 204.004861111111 | 4 | 216.5 | 5 | 1  | 
 |  12893 | 29.9902777777778 | 34 | 188.14 | 3 | 1  | 
 |  12831 | 261.970833333333 | 9 | 215.05 | 5 | 1  | 
 |  12962 | 6.85069444444444 | 16 | 266.39 | 1 | 1  | 
 |  12829 | 336.046527777778 | 11 | 293 | 5 | 1  | 
 |  12881 | 275.025 | 7 | 298 | 5 | 1  | 
 |  12884 | 87.9652777777778 | 7 | 309.05 | 4 | 1  | 
 |  12852 | 294.147916666667 | 17 | 311.55 | 5 | 1  | 
 |  12834 | 282.104861111111 | 18 | 312.38 | 5 | 1  | 
 |  12891 | 184.992361111111 | 3 | 331 | 5 | 2  | 
 |  12875 | 142.868055555556 | 2 | 343.23 | 4 | 2  | 
 |  12953 | 9.12222222222222 | 17 | 329.85 | 2 | 2  | 
 |  12888 | 213.845833333333 | 5 | 354.12 | 5 | 2  | 
 |  12844 | 28.9506944444444 | 52 | 325.96 | 2 | 2  | 
 |  12873 | 281.890277777778 | 4 | 374 | 5 | 2  | 
 |  12845 | 266.948611111111 | 27 | 354.09 | 5 | 2  | 
 |  12915 | 148.031944444444 | 22 | 363.65 | 4 | 2  | 
 |  12871 | 83.8840277777778 | 11 | 380.64 | 4 | 2  | 
 |  12895 | 41.9368055555556 | 22 | 372.8 | 3 | 2  | 
 |  12832 | 31.9513888888889 | 27 | 383.03 | 3 | 2  | 
 |  12824 | 58.9798611111111 | 25 | 397.12 | 3 | 2  | 
 |  12922 | 160.864583333333 | 28 | 405.38 | 4 | 2  | 
 |  12930 | 77.8763888888889 | 25 | 415.8 | 4 | 2  | 
 |  12833 | 144.940277777778 | 24 | 417.38 | 4 | 2  | 
 |  12827 | 5.00208333333333 | 25 | 430.15 | 1 | 2  | 
 |  12890 | 23.7875 | 82 | 380.47 | 2 | 2  | 
 |  12945 | 287.920138888889 | 23 | 462.95 | 5 | 2  | 
 |  12863 | 51.9201388888889 | 5 | 521.2 | 3 | 2  | 
 |  12904 | 17.9069444444444 | 72 | 509.58 | 2 | 2  | 
 |  12879 | 43.9972222222222 | 10 | 573.22 | 3 | 2  | 
 |  12917 | 127.818055555556 | 2 | 594 | 4 | 2  | 
 |  12970 | 6.90972222222222 | 151 | 452.24 | 1 | 3  | 
 |  12944 | 35.0527777777778 | 30 | 604.51 | 3 | 3  | 
 |  12872 | 326.061111111111 | 66 | 599.97 | 5 | 3  | 
 |  12933 | 23.8208333333333 | 106 | 607.53 | 2 | 3  | 
 |  12925 | 4.04791666666667 | 45 | 694.05 | 1 | 3  | 
 |  12883 | 24.1166666666667 | 42 | 703.47 | 2 | 3  | 
 |  12908 | 175.861805555556 | 2 | 750 | 5 | 3  | 
 |  12942 | 130.903472222222 | 75 | 683.9 | 4 | 3  | 
 |  12838 | 33 | 123 | 683.13 | 3 | 3  | 
 |  12965 | 88.8673611111111 | 109 | 771.91 | 4 | 3  | 
 |  12878 | 235.967361111111 | 47 | 854.99 | 5 | 3  | 
 |  12847 | 21.9611111111111 | 91 | 871.54 | 2 | 3  | 
 |  12924 | 87.9340277777778 | 30 | 933.7 | 4 | 3  | 
 |  12822 | 70.0944444444444 | 46 | 948.88 | 3 | 3  | 
 |  12820 | 2.88055555555556 | 59 | 942.34 | 1 | 3  | 
 |  12940 | 54.0076388888889 | 99 | 913.54 | 3 | 3  | 
 |  12828 | 2.14930555555556 | 56 | 1018.71 | 1 | 3  | 
 |  12849 | 30.94375 | 51 | 1050.89 | 3 | 3  | 
 |  12936 | 16.7833333333333 | 62 | 1063.9 | 2 | 3  | 
 |  12951 | 8.00416666666667 | 63 | 1064.07 | 2 | 3  | 
 |  12857 | 210.083333333333 | 46 | 1106.4 | 5 | 3  | 
 |  12842 | 69.8659722222222 | 34 | 1118.99 | 3 | 3  | 
 |  12885 | 62.9444444444444 | 71 | 1175.22 | 3 | 4  | 
 |  12919 | 7.93958333333333 | 50 | 1335.19 | 1 | 4  | 
 |  12854 | 78.0034722222222 | 110 | 1324.5 | 4 | 4  | 
 |  12886 | 67.0909722222222 | 82 | 1378.4 | 3 | 4  | 
 |  12952 | 5.07291666666667 | 79 | 1387.79 | 1 | 4  | 
 |  12882 | 8.83472222222222 | 13 | 1463.04 | 2 | 4  | 
 |  12826 | 2.07986111111111 | 91 | 1474.72 | 1 | 4  | 
 |  12937 | 14.8854166666667 | 120 | 1504.27 | 2 | 4  | 
 |  12967 | 357.715277777778 | 19 | 1660.9 | 5 | 4  | 
 |  12912 | 2.14236111111111 | 24 | 1662.3 | 1 | 4  | 
 |  12877 | 3.07638888888889 | 154 | 1535.77 | 1 | 4  | 
 |  12947 | 143.093055555556 | 97 | 1603.99 | 4 | 4  | 
 |  12868 | 185.068055555556 | 107 | 1607.06 | 5 | 4  | 
 |  12823 | 74.1979166666667 | 5 | 1759.5 | 4 | 4  | 
 |  12843 | 65.0076388888889 | 103 | 1702.26 | 3 | 4  | 
 |  12950 | 1.96041666666667 | 23 | 1843 | 1 | 4  | 
 |  12963 | 7.97569444444444 | 95 | 1856.63 | 1 | 4  | 
 |  12853 | 134.035416666667 | 78 | 1957.1 | 4 | 4  | 
 |  12928 | 34.9138888888889 | 84 | 2062.7 | 3 | 4  | 
 |  12948 | 15.7986111111111 | 116 | 2064.95 | 2 | 4  | 
 |  12909 | 38.9840277777778 | 91 | 2178.67 | 3 | 4  | 
 |  12935 | 1.78819444444444 | 129 | 2160.7 | 1 | 4  | 
 |  12856 | 7.06111111111111 | 314 | 2179.93 | 1 | 5  | 
 |  12913 | 4.00625 | 50 | 2483.63 | 1 | 5  | 
 |  12836 | 58.8819444444444 | 175 | 2612.86 | 3 | 5  | 
 |  12840 | 143.11875 | 113 | 2726.77 | 4 | 5  | 
 |  12906 | 11.1006944444444 | 63 | 2919.81 | 2 | 5  | 
 |  12916 | 138.072916666667 | 107 | 3006.15 | 4 | 5  | 
 |  12910 | 22.9111111111111 | 75 | 3075.04 | 2 | 5  | 
 |  12957 | 9.10208333333333 | 238 | 4017.54 | 2 | 5  | 
 |  12749 | 3.1 | 199 | 4090.88 | 1 | 5  | 
 |  12747 | 1.90694444444444 | 103 | 4196.01 | 1 | 5  | 
 |  12949 | 30.0381944444444 | 215 | 4167.22 | 3 | 5  | 
 |  12841 | 4.04652777777778 | 420 | 4022.35 | 1 | 5  | 
 |  12867 | 25.8680555555555 | 538 | 4036.82 | 2 | 5  | 
 |  12955 | 0.827083333333333 | 180 | 4757.16 | 1 | 5  | 
 |  12971 | 167.905555555556 | 153 | 5190.74 | 4 | 5  | 
 |  12839 | 1.99097222222222 | 314 | 5591.42 | 1 | 5  | 
 |  12830 | 37.0180555555555 | 38 | 6814.64 | 3 | 5  | 
 |  12939 | 63.9076388888889 | 47 | 11581.8 | 3 | 5  | 
 |  12921 | 8.83194444444444 | 720 | 16587.09 | 2 | 5  | 
 |  12901 | 8.09236111111111 | 116 | 17654.54 | 2 | 5  | 
 |  12748 | 0 | 4596 | 33719.73 | 1 | 5  | 
 |  12931 | 20.9868055555555 | 82 | 42055.96 | 2 | 5 |

```sql
-- Step 3 (add labels)

 select CUSTOMER_ID, Recency, freguency, monetary, R_Score, FM_Score, 
           CASE WHEN R_Score = 5 AND FM_Score = 5 THEN 'Champions' 
            WHEN R_Score = 5 AND FM_Score = 4 THEN 'Champions' 
            WHEN R_Score = 4 AND FM_Score = 5 THEN 'Champions' 

            WHEN R_Score = 5 AND FM_Score = 2 THEN 'Potential Loyalists' 
            WHEN R_Score = 4 AND FM_Score = 2 THEN 'Potential Loyalists' 
            WHEN R_Score = 3 AND FM_Score = 3 THEN 'Potential Loyalists' 
            WHEN R_Score = 4 AND FM_Score = 3 THEN 'Potential Loyalists' 

            WHEN R_Score = 5 AND FM_Score = 3 THEN 'Loyal Customers' 
            WHEN R_Score = 4 AND FM_Score = 4 THEN 'Loyal Customers' 
            WHEN R_Score = 3 AND FM_Score = 5 THEN 'Loyal Customers' 
            WHEN R_Score = 3 AND FM_Score = 4 THEN 'Loyal Customers' 

            WHEN R_Score = 5 AND FM_Score = 1 THEN 'Recent Customers' 
           
            WHEN R_Score = 4 AND FM_Score = 1 THEN 'Promising' 
            WHEN R_Score = 3 AND FM_Score = 1 THEN 'Promising' 

            WHEN R_Score = 3 AND FM_Score = 2 THEN 'Customers Needing Attention' 
            WHEN R_Score = 2 AND FM_Score = 3 THEN 'Customers Needing Attention' 
            WHEN R_Score = 2 AND FM_Score = 2 THEN 'Customers Needing Attention' 

            WHEN R_Score = 2 AND FM_Score = 5 THEN 'At Risk' 
            WHEN R_Score = 2 AND FM_Score = 4 THEN 'At Risk' 
            WHEN R_Score = 1 AND FM_Score = 3 THEN 'At Risk' 

            WHEN R_Score = 1 AND FM_Score = 5 THEN 'Cannot Lose Them' 
            WHEN R_Score = 1 AND FM_Score = 4 THEN 'Cannot Lose Them' 

            WHEN R_Score = 1 AND FM_Score = 2 THEN 'Hibernating' 

            WHEN R_Score = 2 AND FM_Score = 1 THEN 'About to Sleep' 
            
            WHEN R_Score = 1 AND FM_Score = 1 THEN 'Lost' 
           End Cust_Segment
            from(
            select CUSTOMER_ID, Recency, freguency, monetary,
                    NTILE(5) over(order by Recency)  R_Score,
                    NTILE(5) over(order by avg_FM)  FM_Score
                    from(      
                            select distinct(CUSTOMER_ID),
                                        max(to_date( INVOICEDATE, 'MM/DD/YYYY HH24:MI'))over() - max(to_date( INVOICEDATE, 'MM/DD/YYYY HH24:MI'))over(partition by CUSTOMER_ID) Recency,
                                        count(*)over( partition by CUSTOMER_ID ) freguency,
                                        sum(PRICE*QUANTITY)over( partition by CUSTOMER_ID ) monetary,
                                        (count(*)over( partition by CUSTOMER_ID ) + sum(PRICE*QUANTITY)over( partition by CUSTOMER_ID ))/2 avg_FM
                            from tableretail));   
```

The final output:

 | CUSTOMER_ID | RECENCY | FREQUENCY | MONETARY | R_SCORE | FM_SCORE | CUSTOMER_SEGMENT |
 | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
 | 12855 | 372.113194444444 | 3 | 38.1 | 5 | 1 | Recent Customers  | 
 |  12821 | 213.853472222222 | 6 | 92.72 | 5 | 1 | Recent Customers  | 
 |  12938 | 25.0409722222222 | 9 | 114.14 | 2 | 1 | About to | Sleep  | 
 |  12929 | 311.008333333333 | 8 | 117.85 | 5 | 1 | Recent Customers  | 
 |  12956 | 305.841666666667 | 19 | 108.07 | 5 | 1 | Recent Customers  | 
 |  12968 | 111.858333333333 | 5 | 135.95 | 4 | 1 | Promising  | 
 |  12837 | 172.842361111111 | 12 | 134.1 | 4 | 1 | Promising  | 
 |  12902 | 264.009722222222 | 10 | 138.68 | 5 | 1 | Recent Customers  | 
 |  12864 | 137.970138888889 | 3 | 147.12 | 4 | 1 | Promising  | 
 |  12966 | 8.9875 | 10 | 160.18 | 2 | 1 | About to Sleep  | 
 |  12851 | 95.9854166666667 | 50 | 135.18 | 4 | 1 | Promising  | 
 |  12920 | 16.8854166666667 | 28 | 164.23 | 2 | 1 | About to Sleep  | 
 |  12923 | 63.8333333333333 | 29 | 176.97 | 3 | 1 | Promising  | 
 |  12897 | 204.004861111111 | 4 | 216.5 | 5 | 1 | Recent Customers  | 
 |  12893 | 29.9902777777778 | 34 | 188.14 | 3 | 1 | Promising  | 
 |  12831 | 261.970833333333 | 9 | 215.05 | 5 | 1 | Recent Customers  | 
 |  12962 | 6.85069444444444 | 16 | 266.39 | 1 | 1 | Lost  | 
 |  12829 | 336.046527777778 | 11 | 293 | 5 | 1 | Recent Customers  | 
 |  12881 | 275.025 | 7 | 298 | 5 | 1 | Recent Customers  | 
 |  12884 | 87.9652777777778 | 7 | 309.05 | 4 | 1 | Promising  | 
 |  12852 | 294.147916666667 | 17 | 311.55 | 5 | 1 | Recent Customers  | 
 |  12834 | 282.104861111111 | 18 | 312.38 | 5 | 1 | Recent Customers  | 
 |  12891 | 184.992361111111 | 3 | 331 | 5 | 2 | Potential Loyalists  | 
 |  12875 | 142.868055555556 | 2 | 343.23 | 4 | 2 | Potential Loyalists  | 
 |  12953 | 9.12222222222222 | 17 | 329.85 | 2 | 2 | Customers Needing Attention  | 
 |  12888 | 213.845833333333 | 5 | 354.12 | 5 | 2 | Potential Loyalists  | 
 |  12844 | 28.9506944444444 | 52 | 325.96 | 2 | 2 | Customers Needing Attention  | 
 |  12873 | 281.890277777778 | 4 | 374 | 5 | 2 | Potential Loyalists  | 
 |  12845 | 266.948611111111 | 27 | 354.09 | 5 | 2 | Potential Loyalists  | 
 |  12915 | 148.031944444444 | 22 | 363.65 | 4 | 2 | Potential Loyalists  | 
 |  12871 | 83.8840277777778 | 11 | 380.64 | 4 | 2 | Potential Loyalists  | 
 |  12895 | 41.9368055555556 | 22 | 372.8 | 3 | 2 | Customers Needing Attention  | 
 |  12832 | 31.9513888888889 | 27 | 383.03 | 3 | 2 | Customers Needing Attention  | 
 |  12824 | 58.9798611111111 | 25 | 397.12 | 3 | 2 | Customers Needing Attention  | 
 |  12922 | 160.864583333333 | 28 | 405.38 | 4 | 2 | Potential Loyalists  | 
 |  12930 | 77.8763888888889 | 25 | 415.8 | 4 | 2 | Potential Loyalists  | 
 |  12833 | 144.940277777778 | 24 | 417.38 | 4 | 2 | Potential Loyalists  | 
 |  12827 | 5.00208333333333 | 25 | 430.15 | 1 | 2 | Hibernating  | 
 |  12890 | 23.7875 | 82 | 380.47 | 2 | 2 | Customers Needing Attention  | 
 |  12945 | 287.920138888889 | 23 | 462.95 | 5 | 2 | Potential Loyalists  | 
 |  12863 | 51.9201388888889 | 5 | 521.2 | 3 | 2 | Customers Needing Attention  | 
 |  12904 | 17.9069444444444 | 72 | 509.58 | 2 | 2 | Customers Needing Attention  | 
 |  12879 | 43.9972222222222 | 10 | 573.22 | 3 | 2 | Customers Needing Attention  | 
 |  12917 | 127.818055555556 | 2 | 594 | 4 | 2 | Potential Loyalists  | 
 |  12970 | 6.90972222222222 | 151 | 452.24 | 1 | 3 | At Risk  | 
 |  12944 | 35.0527777777778 | 30 | 604.51 | 3 | 3 | Potential Loyalists  | 
 |  12872 | 326.061111111111 | 66 | 599.97 | 5 | 3 | Loyal Customers  | 
 |  12933 | 23.8208333333333 | 106 | 607.53 | 2 | 3 | Customers Needing Attention  | 
 |  12925 | 4.04791666666667 | 45 | 694.05 | 1 | 3 | At Risk  | 
 |  12883 | 24.1166666666667 | 42 | 703.47 | 2 | 3 | Customers Needing Attention  | 
 |  12908 | 175.861805555556 | 2 | 750 | 5 | 3 | Loyal Customers  | 
 |  12942 | 130.903472222222 | 75 | 683.9 | 4 | 3 | Potential Loyalists  | 
 |  12838 | 33 | 123 | 683.13 | 3 | 3 | Potential Loyalists  | 
 |  12965 | 88.8673611111111 | 109 | 771.91 | 4 | 3 | Potential Loyalists  | 
 |  12878 | 235.967361111111 | 47 | 854.99 | 5 | 3 | Loyal Customers  | 
 |  12847 | 21.9611111111111 | 91 | 871.54 | 2 | 3 | Customers Needing Attention  | 
 |  12924 | 87.9340277777778 | 30 | 933.7 | 4 | 3 | Potential Loyalists  | 
 |  12822 | 70.0944444444444 | 46 | 948.88 | 3 | 3 | Potential Loyalists  | 
 |  12820 | 2.88055555555556 | 59 | 942.34 | 1 | 3 | At Risk  | 
 |  12940 | 54.0076388888889 | 99 | 913.54 | 3 | 3 | Potential Loyalists  | 
 |  12828 | 2.14930555555556 | 56 | 1018.71 | 1 | 3 | At Risk  | 
 |  12849 | 30.94375 | 51 | 1050.89 | 3 | 3 | Potential Loyalists  | 
 |  12936 | 16.7833333333333 | 62 | 1063.9 | 2 | 3 | Customers Needing Attention  | 
 |  12951 | 8.00416666666667 | 63 | 1064.07 | 2 | 3 | Customers Needing Attention  | 
 |  12857 | 210.083333333333 | 46 | 1106.4 | 5 | 3 | Loyal Customers  | 
 |  12842 | 69.8659722222222 | 34 | 1118.99 | 3 | 3 | Potential Loyalists  | 
 |  12885 | 62.9444444444444 | 71 | 1175.22 | 3 | 4 | Loyal Customers  | 
 |  12919 | 7.93958333333333 | 50 | 1335.19 | 1 | 4 | Cannot Lose Them  | 
 |  12854 | 78.0034722222222 | 110 | 1324.5 | 4 | 4 | Loyal Customers  | 
 |  12886 | 67.0909722222222 | 82 | 1378.4 | 3 | 4 | Loyal Customers  | 
 |  12952 | 5.07291666666667 | 79 | 1387.79 | 1 | 4 | Cannot Lose Them  | 
 |  12882 | 8.83472222222222 | 13 | 1463.04 | 2 | 4 | At Risk  | 
 |  12826 | 2.07986111111111 | 91 | 1474.72 | 1 | 4 | Cannot Lose Them  | 
 |  12937 | 14.8854166666667 | 120 | 1504.27 | 2 | 4 | At Risk  | 
 |  12967 | 357.715277777778 | 19 | 1660.9 | 5 | 4 | Champions  | 
 |  12912 | 2.14236111111111 | 24 | 1662.3 | 1 | 4 | Cannot Lose Them  | 
 |  12877 | 3.07638888888889 | 154 | 1535.77 | 1 | 4 | Cannot Lose Them  | 
 |  12947 | 143.093055555556 | 97 | 1603.99 | 4 | 4 | Loyal Customers  | 
 |  12868 | 185.068055555556 | 107 | 1607.06 | 5 | 4 | Champions  | 
 |  12823 | 74.1979166666667 | 5 | 1759.5 | 4 | 4 | Loyal Customers  | 
 |  12843 | 65.0076388888889 | 103 | 1702.26 | 3 | 4 | Loyal Customers  | 
 |  12950 | 1.96041666666667 | 23 | 1843 | 1 | 4 | Cannot Lose Them  | 
 |  12963 | 7.97569444444444 | 95 | 1856.63 | 1 | 4 | Cannot Lose Them  | 
 |  12853 | 134.035416666667 | 78 | 1957.1 | 4 | 4 | Loyal Customers  | 
 |  12928 | 34.9138888888889 | 84 | 2062.7 | 3 | 4 | Loyal Customers  | 
 |  12948 | 15.7986111111111 | 116 | 2064.95 | 2 | 4 | At Risk  | 
 |  12909 | 38.9840277777778 | 91 | 2178.67 | 3 | 4 | Loyal Customers  | 
 |  12935 | 1.78819444444444 | 129 | 2160.7 | 1 | 4 | Cannot Lose Them  | 
 |  12856 | 7.06111111111111 | 314 | 2179.93 | 1 | 5 | Cannot Lose Them  | 
 |  12913 | 4.00625 | 50 | 2483.63 | 1 | 5 | Cannot Lose Them  | 
 |  12836 | 58.8819444444444 | 175 | 2612.86 | 3 | 5 | Loyal Customers  | 
 |  12840 | 143.11875 | 113 | 2726.77 | 4 | 5 | Champions  | 
 |  12906 | 11.1006944444444 | 63 | 2919.81 | 2 | 5 | At Risk  | 
 |  12916 | 138.072916666667 | 107 | 3006.15 | 4 | 5 | Champions  | 
 |  12910 | 22.9111111111111 | 75 | 3075.04 | 2 | 5 | At | Risk  | 
 |  12957 | 9.10208333333333 | 238 | 4017.54 | 2 | 5 | At Risk  | 
 |  12749 | 3.1 | 199 | 4090.88 | 1 | 5 | Cannot Lose Them  | 
 |  12747 | 1.90694444444444 | 103 | 4196.01 | 1 | 5 | Cannot Lose Them  | 
 |  12949 | 30.0381944444444 | 215 | 4167.22 | 3 | 5 | Loyal Customers  | 
 |  12841 | 4.04652777777778 | 420 | 4022.35 | 1 | 5 | Cannot Lose Them  | 
 |  12867 | 25.8680555555555 | 538 | 4036.82 | 2 | 5 | At Risk  | 
 |  12955 | 0.827083333333333 | 180 | 4757.16 | 1 | 5 | Cannot Lose Them  | 
 |  12971 | 167.905555555556 | 153 | 5190.74 | 4 | 5 | Champions  | 
 |  12839 | 1.99097222222222 | 314 | 5591.42 | 1 | 5 | Cannot Lose Them  | 
 |  12830 | 37.0180555555555 | 38 | 6814.64 | 3 | 5 | Loyal Customers  | 
 |  12939 | 63.9076388888889 | 47 | 11581.8 | 3 | 5 | Loyal Customers  | 
 |  12921 | 8.83194444444444 | 720 | 16587.09 | 2 | 5 | At Risk  | 
 |  12901 | 8.09236111111111 | 116 | 17654.54 | 2 | 5 | At Risk  | 
 |  12748 | 0 | 4596 | 33719.73 | 1 | 5 | Cannot Lose Them  | 
 |  12931 | 20.9868055555555 | 82 | 42055.96 | 2 | 5 | At Risk |


